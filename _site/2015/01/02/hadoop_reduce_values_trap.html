<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Traps in hadoop reducer's values parameter</title>
    <meta name="description" content="Thinking, coding.
">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="http://QAMichaelPeng.github.io/2015/01/02/hadoop_reduce_values_trap.html">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">QAMichaelPeng</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Traps in hadoop reducer's values parameter</h1>
    <p class="post-meta">Jan 2, 2015</p>
  </header>

  <article class="post-content">
    <p>To learn hadoop, I wrote a simple application to calculate min price and max price of all NYSE stocks in a period.</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="lineno">  1</span> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">MinMaxCalc</span> <span class="o">{</span>
<span class="lineno">  2</span> 
<span class="lineno">  3</span>     <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">StockMinMaxWritable</span> <span class="kd">implements</span>  <span class="n">Writable</span> <span class="o">{</span>
<span class="lineno">  4</span>         <span class="kd">private</span> <span class="n">DateWritable</span> <span class="n">minDate</span><span class="o">;</span>
<span class="lineno">  5</span>         <span class="kd">private</span> <span class="n">HiveDecimalWritable</span> <span class="n">minPrice</span><span class="o">;</span>
<span class="lineno">  6</span>         <span class="kd">private</span> <span class="n">DateWritable</span> <span class="n">maxDate</span><span class="o">;</span>
<span class="lineno">  7</span>         <span class="kd">private</span> <span class="n">HiveDecimalWritable</span> <span class="n">maxPrice</span><span class="o">;</span>
<span class="lineno">  8</span> 
<span class="lineno">  9</span>         <span class="kd">public</span> <span class="nf">StockMinMaxWritable</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno"> 10</span>             <span class="n">minDate</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">DateWritable</span><span class="o">();</span>
<span class="lineno"> 11</span>             <span class="n">minPrice</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">HiveDecimalWritable</span><span class="o">();</span>
<span class="lineno"> 12</span>             <span class="n">maxDate</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">DateWritable</span><span class="o">();</span>
<span class="lineno"> 13</span>             <span class="n">maxPrice</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">HiveDecimalWritable</span><span class="o">();</span>
<span class="lineno"> 14</span>         <span class="o">}</span>
<span class="lineno"> 15</span> 
<span class="lineno"> 16</span>         <span class="kd">public</span> <span class="n">DateWritable</span> <span class="nf">getMinDate</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno"> 17</span>             <span class="k">return</span> <span class="n">minDate</span><span class="o">;</span>
<span class="lineno"> 18</span>         <span class="o">}</span>
<span class="lineno"> 19</span> 
<span class="lineno"> 20</span>         <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setMinDate</span><span class="o">(</span><span class="n">DateWritable</span> <span class="n">minDate</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 21</span>             <span class="k">this</span><span class="o">.</span><span class="na">minDate</span> <span class="o">=</span> <span class="n">minDate</span><span class="o">;</span>
<span class="lineno"> 22</span>         <span class="o">}</span>
<span class="lineno"> 23</span> 
<span class="lineno"> 24</span>         <span class="kd">public</span> <span class="n">HiveDecimalWritable</span> <span class="nf">getMinPrice</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno"> 25</span>             <span class="k">return</span> <span class="n">minPrice</span><span class="o">;</span>
<span class="lineno"> 26</span>         <span class="o">}</span>
<span class="lineno"> 27</span> 
<span class="lineno"> 28</span>         <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setMinPrice</span><span class="o">(</span><span class="n">HiveDecimalWritable</span> <span class="n">minPrice</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 29</span>             <span class="k">this</span><span class="o">.</span><span class="na">minPrice</span> <span class="o">=</span> <span class="n">minPrice</span><span class="o">;</span>
<span class="lineno"> 30</span>         <span class="o">}</span>
<span class="lineno"> 31</span> 
<span class="lineno"> 32</span>         <span class="kd">public</span> <span class="n">DateWritable</span> <span class="nf">getMaxDate</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno"> 33</span>             <span class="k">return</span> <span class="n">maxDate</span><span class="o">;</span>
<span class="lineno"> 34</span>         <span class="o">}</span>
<span class="lineno"> 35</span> 
<span class="lineno"> 36</span>         <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setMaxDate</span><span class="o">(</span><span class="n">DateWritable</span> <span class="n">maxDate</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 37</span>             <span class="k">this</span><span class="o">.</span><span class="na">maxDate</span> <span class="o">=</span> <span class="n">maxDate</span><span class="o">;</span>
<span class="lineno"> 38</span>         <span class="o">}</span>
<span class="lineno"> 39</span> 
<span class="lineno"> 40</span>         <span class="kd">public</span> <span class="n">HiveDecimalWritable</span> <span class="nf">getMaxPrice</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno"> 41</span>             <span class="k">return</span> <span class="n">maxPrice</span><span class="o">;</span>
<span class="lineno"> 42</span>         <span class="o">}</span>
<span class="lineno"> 43</span> 
<span class="lineno"> 44</span>         <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setMaxPrice</span><span class="o">(</span><span class="n">HiveDecimalWritable</span> <span class="n">maxPrice</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 45</span>             <span class="k">this</span><span class="o">.</span><span class="na">maxPrice</span> <span class="o">=</span> <span class="n">maxPrice</span><span class="o">;</span>
<span class="lineno"> 46</span>         <span class="o">}</span>
<span class="lineno"> 47</span> 
<span class="lineno"> 48</span>         <span class="nd">@Override</span>
<span class="lineno"> 49</span>         <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">DataOutput</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
<span class="lineno"> 50</span>             <span class="n">minDate</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">out</span><span class="o">);</span>
<span class="lineno"> 51</span>             <span class="n">minPrice</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">out</span><span class="o">);</span>
<span class="lineno"> 52</span>             <span class="n">maxDate</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">out</span><span class="o">);</span>
<span class="lineno"> 53</span>             <span class="n">maxPrice</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">out</span><span class="o">);</span>
<span class="lineno"> 54</span>         <span class="o">}</span>
<span class="lineno"> 55</span> 
<span class="lineno"> 56</span>         <span class="nd">@Override</span>
<span class="lineno"> 57</span>         <span class="kd">public</span> <span class="kt">void</span> <span class="nf">readFields</span><span class="o">(</span><span class="n">DataInput</span> <span class="n">in</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
<span class="lineno"> 58</span>             <span class="n">minDate</span><span class="o">.</span><span class="na">readFields</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>
<span class="lineno"> 59</span>             <span class="n">minPrice</span><span class="o">.</span><span class="na">readFields</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>
<span class="lineno"> 60</span>             <span class="n">maxDate</span><span class="o">.</span><span class="na">readFields</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>
<span class="lineno"> 61</span>             <span class="n">maxPrice</span><span class="o">.</span><span class="na">readFields</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>
<span class="lineno"> 62</span>         <span class="o">}</span>
<span class="lineno"> 63</span> 
<span class="lineno"> 64</span>         <span class="nd">@Override</span>
<span class="lineno"> 65</span>         <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno"> 66</span>             <span class="n">StringBuilder</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">StringBuilder</span><span class="o">();</span>
<span class="lineno"> 67</span>             <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">minDate</span><span class="o">.</span><span class="na">toString</span><span class="o">()).</span><span class="na">append</span><span class="o">(</span><span class="sc">&#39;\t&#39;</span><span class="o">).</span>
<span class="lineno"> 68</span>                     <span class="n">append</span><span class="o">(</span><span class="n">minPrice</span><span class="o">.</span><span class="na">toString</span><span class="o">()).</span><span class="na">append</span><span class="o">(</span><span class="sc">&#39;\t&#39;</span><span class="o">).</span>
<span class="lineno"> 69</span>                     <span class="n">append</span><span class="o">(</span><span class="n">maxDate</span><span class="o">.</span><span class="na">toString</span><span class="o">()).</span><span class="na">append</span><span class="o">(</span><span class="sc">&#39;\t&#39;</span><span class="o">).</span>
<span class="lineno"> 70</span>                     <span class="n">append</span><span class="o">(</span><span class="n">maxPrice</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
<span class="lineno"> 71</span>             <span class="k">return</span> <span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
<span class="lineno"> 72</span>         <span class="o">}</span>
<span class="lineno"> 73</span>     <span class="o">}</span>
<span class="lineno"> 74</span> 
<span class="lineno"> 75</span>     <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">StockDailyDataWritable</span> <span class="kd">implements</span> <span class="n">Writable</span> <span class="o">{</span>
<span class="lineno"> 76</span>         <span class="kd">private</span> <span class="n">DateWritable</span> <span class="n">date</span><span class="o">;</span>
<span class="lineno"> 77</span>         <span class="kd">private</span> <span class="n">HiveDecimalWritable</span> <span class="n">priceOpen</span><span class="o">;</span>
<span class="lineno"> 78</span>         <span class="kd">private</span> <span class="n">HiveDecimalWritable</span> <span class="n">priceHigh</span><span class="o">;</span>
<span class="lineno"> 79</span>         <span class="kd">private</span> <span class="n">HiveDecimalWritable</span> <span class="n">priceLow</span><span class="o">;</span>
<span class="lineno"> 80</span>         <span class="kd">private</span> <span class="n">HiveDecimalWritable</span> <span class="n">priceClose</span><span class="o">;</span>
<span class="lineno"> 81</span> 
<span class="lineno"> 82</span>         <span class="kd">public</span> <span class="nf">StockDailyDataWritable</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno"> 83</span>             <span class="n">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">DateWritable</span><span class="o">();</span>
<span class="lineno"> 84</span>             <span class="n">priceOpen</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">HiveDecimalWritable</span><span class="o">();</span>
<span class="lineno"> 85</span>             <span class="n">priceHigh</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">HiveDecimalWritable</span><span class="o">();</span>
<span class="lineno"> 86</span>             <span class="n">priceLow</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">HiveDecimalWritable</span><span class="o">();</span>
<span class="lineno"> 87</span>             <span class="n">priceClose</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">HiveDecimalWritable</span><span class="o">();</span>
<span class="lineno"> 88</span>         <span class="o">}</span>
<span class="lineno"> 89</span> 
<span class="lineno"> 90</span>         <span class="kd">public</span> <span class="n">DateWritable</span> <span class="nf">getDate</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno"> 91</span>             <span class="k">return</span> <span class="n">date</span><span class="o">;</span>
<span class="lineno"> 92</span>         <span class="o">}</span>
<span class="lineno"> 93</span> 
<span class="lineno"> 94</span>         <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDate</span><span class="o">(</span><span class="n">DateWritable</span> <span class="n">date</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 95</span>             <span class="k">this</span><span class="o">.</span><span class="na">date</span> <span class="o">=</span> <span class="n">date</span><span class="o">;</span>
<span class="lineno"> 96</span>         <span class="o">}</span>
<span class="lineno"> 97</span> 
<span class="lineno"> 98</span>         <span class="kd">public</span> <span class="n">HiveDecimalWritable</span> <span class="nf">getPriceOpen</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno"> 99</span>             <span class="k">return</span> <span class="n">priceOpen</span><span class="o">;</span>
<span class="lineno">100</span>         <span class="o">}</span>
<span class="lineno">101</span> 
<span class="lineno">102</span>         <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPriceOpen</span><span class="o">(</span><span class="n">HiveDecimalWritable</span> <span class="n">priceOpen</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">103</span>             <span class="k">this</span><span class="o">.</span><span class="na">priceOpen</span> <span class="o">=</span> <span class="n">priceOpen</span><span class="o">;</span>
<span class="lineno">104</span>         <span class="o">}</span>
<span class="lineno">105</span> 
<span class="lineno">106</span>         <span class="kd">public</span> <span class="n">HiveDecimalWritable</span> <span class="nf">getPriceHigh</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno">107</span>             <span class="k">return</span> <span class="n">priceHigh</span><span class="o">;</span>
<span class="lineno">108</span>         <span class="o">}</span>
<span class="lineno">109</span> 
<span class="lineno">110</span>         <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPriceHigh</span><span class="o">(</span><span class="n">HiveDecimalWritable</span> <span class="n">priceHigh</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">111</span>             <span class="k">this</span><span class="o">.</span><span class="na">priceHigh</span> <span class="o">=</span> <span class="n">priceHigh</span><span class="o">;</span>
<span class="lineno">112</span>         <span class="o">}</span>
<span class="lineno">113</span> 
<span class="lineno">114</span>         <span class="kd">public</span> <span class="n">HiveDecimalWritable</span> <span class="nf">getPriceLow</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno">115</span>             <span class="k">return</span> <span class="n">priceLow</span><span class="o">;</span>
<span class="lineno">116</span>         <span class="o">}</span>
<span class="lineno">117</span> 
<span class="lineno">118</span>         <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPriceLow</span><span class="o">(</span><span class="n">HiveDecimalWritable</span> <span class="n">priceLow</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">119</span>             <span class="k">this</span><span class="o">.</span><span class="na">priceLow</span> <span class="o">=</span> <span class="n">priceLow</span><span class="o">;</span>
<span class="lineno">120</span>         <span class="o">}</span>
<span class="lineno">121</span> 
<span class="lineno">122</span>         <span class="kd">public</span> <span class="n">HiveDecimalWritable</span> <span class="nf">getPriceClose</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno">123</span>             <span class="k">return</span> <span class="n">priceClose</span><span class="o">;</span>
<span class="lineno">124</span>         <span class="o">}</span>
<span class="lineno">125</span> 
<span class="lineno">126</span>         <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPriceClose</span><span class="o">(</span><span class="n">HiveDecimalWritable</span> <span class="n">priceClose</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">127</span>             <span class="k">this</span><span class="o">.</span><span class="na">priceClose</span> <span class="o">=</span> <span class="n">priceClose</span><span class="o">;</span>
<span class="lineno">128</span>         <span class="o">}</span>
<span class="lineno">129</span> 
<span class="lineno">130</span>         <span class="nd">@Override</span>
<span class="lineno">131</span>         <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">DataOutput</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
<span class="lineno">132</span>             <span class="n">date</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">out</span><span class="o">);</span>
<span class="lineno">133</span>             <span class="n">priceOpen</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">out</span><span class="o">);</span>
<span class="lineno">134</span>             <span class="n">priceHigh</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">out</span><span class="o">);</span>
<span class="lineno">135</span>             <span class="n">priceLow</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">out</span><span class="o">);</span>
<span class="lineno">136</span>             <span class="n">priceClose</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">out</span><span class="o">);</span>
<span class="lineno">137</span>         <span class="o">}</span>
<span class="lineno">138</span> 
<span class="lineno">139</span>         <span class="nd">@Override</span>
<span class="lineno">140</span>         <span class="kd">public</span> <span class="kt">void</span> <span class="nf">readFields</span><span class="o">(</span><span class="n">DataInput</span> <span class="n">in</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
<span class="lineno">141</span>             <span class="k">if</span> <span class="o">(</span><span class="n">priceClose</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="n">priceClose</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">HiveDecimalWritable</span><span class="o">();</span>
<span class="lineno">142</span>             <span class="n">date</span><span class="o">.</span><span class="na">readFields</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>
<span class="lineno">143</span>             <span class="n">priceOpen</span><span class="o">.</span><span class="na">readFields</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>
<span class="lineno">144</span>             <span class="n">priceHigh</span><span class="o">.</span><span class="na">readFields</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>
<span class="lineno">145</span>             <span class="n">priceLow</span><span class="o">.</span><span class="na">readFields</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>
<span class="lineno">146</span>             <span class="n">priceClose</span><span class="o">.</span><span class="na">readFields</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>
<span class="lineno">147</span>         <span class="o">}</span>
<span class="lineno">148</span>     <span class="o">}</span>
<span class="lineno">149</span> 
<span class="lineno">150</span>     <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">StockMapper</span> <span class="kd">extends</span> <span class="n">Mapper</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span> <span class="n">Text</span><span class="o">,</span> <span class="n">Text</span><span class="o">,</span> <span class="n">StockDailyDataWritable</span><span class="o">&gt;</span> <span class="o">{</span>
<span class="lineno">151</span>         <span class="nd">@Override</span>
<span class="lineno">152</span>         <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">map</span><span class="o">(</span><span class="n">Object</span> <span class="n">key</span><span class="o">,</span> <span class="n">Text</span> <span class="n">value</span><span class="o">,</span> <span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">InterruptedException</span> <span class="o">{</span>
<span class="lineno">153</span>             <span class="c1">//super.map(key, value, context);</span>
<span class="lineno">154</span>             <span class="n">String</span><span class="o">[]</span> <span class="n">fields</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">split</span><span class="o">(</span><span class="s">&quot;\t&quot;</span><span class="o">);</span>
<span class="lineno">155</span>             <span class="n">StockDailyDataWritable</span> <span class="n">writable</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">StockDailyDataWritable</span><span class="o">();</span>
<span class="lineno">156</span>             <span class="n">SimpleDateFormat</span> <span class="n">dateFormat</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">SimpleDateFormat</span><span class="o">(</span><span class="s">&quot;yyyy-MM-dd&quot;</span><span class="o">);</span>
<span class="lineno">157</span>             <span class="n">Date</span> <span class="n">date</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="lineno">158</span>             <span class="k">try</span> <span class="o">{</span>
<span class="lineno">159</span>                 <span class="n">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Date</span><span class="o">(</span><span class="n">dateFormat</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">fields</span><span class="o">[</span><span class="mi">2</span><span class="o">]).</span><span class="na">getTime</span><span class="o">());</span>
<span class="lineno">160</span>             <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ParseException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">161</span>                 <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
<span class="lineno">162</span>             <span class="o">}</span>
<span class="lineno">163</span>             <span class="n">writable</span><span class="o">.</span><span class="na">setDate</span><span class="o">(</span><span class="k">new</span> <span class="nf">DateWritable</span><span class="o">(</span><span class="n">date</span><span class="o">));</span>
<span class="lineno">164</span>             <span class="n">writable</span><span class="o">.</span><span class="na">setPriceOpen</span><span class="o">(</span><span class="k">new</span> <span class="nf">HiveDecimalWritable</span><span class="o">(</span><span class="n">HiveDecimal</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="k">new</span> <span class="nf">BigDecimal</span><span class="o">(</span><span class="n">fields</span><span class="o">[</span><span class="mi">3</span><span class="o">]))));</span>
<span class="lineno">165</span>             <span class="n">writable</span><span class="o">.</span><span class="na">setPriceHigh</span><span class="o">(</span><span class="k">new</span> <span class="nf">HiveDecimalWritable</span><span class="o">(</span><span class="n">HiveDecimal</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="k">new</span> <span class="nf">BigDecimal</span><span class="o">(</span><span class="n">fields</span><span class="o">[</span><span class="mi">4</span><span class="o">]))));</span>
<span class="lineno">166</span>             <span class="n">writable</span><span class="o">.</span><span class="na">setPriceLow</span><span class="o">(</span><span class="k">new</span> <span class="nf">HiveDecimalWritable</span><span class="o">(</span><span class="n">HiveDecimal</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="k">new</span> <span class="nf">BigDecimal</span><span class="o">(</span><span class="n">fields</span><span class="o">[</span><span class="mi">5</span><span class="o">]))));</span>
<span class="lineno">167</span>             <span class="n">writable</span><span class="o">.</span><span class="na">setPriceClose</span><span class="o">(</span><span class="k">new</span> <span class="nf">HiveDecimalWritable</span><span class="o">(</span><span class="n">HiveDecimal</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="k">new</span> <span class="nf">BigDecimal</span><span class="o">(</span><span class="n">fields</span><span class="o">[</span><span class="mi">6</span><span class="o">]))));</span>
<span class="lineno">168</span>             <span class="n">Text</span> <span class="n">symbol</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Text</span><span class="o">(</span><span class="n">fields</span><span class="o">[</span><span class="mi">1</span><span class="o">]);</span>
<span class="lineno">169</span>             <span class="n">context</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">symbol</span><span class="o">,</span> <span class="n">writable</span><span class="o">);</span>
<span class="lineno">170</span>         <span class="o">}</span>
<span class="lineno">171</span>     <span class="o">}</span>
<span class="lineno">172</span> 
<span class="lineno">173</span>     <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">StockReducer</span> <span class="kd">extends</span> <span class="n">Reducer</span><span class="o">&lt;</span><span class="n">Text</span><span class="o">,</span> <span class="n">StockDailyDataWritable</span><span class="o">,</span><span class="n">Text</span><span class="o">,</span> <span class="n">StockMinMaxWritable</span><span class="o">&gt;</span> <span class="o">{</span>
<span class="lineno">174</span> 
<span class="lineno">175</span>         <span class="nd">@Override</span>
<span class="lineno">176</span>         <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">reduce</span><span class="o">(</span><span class="n">Text</span> <span class="n">key</span><span class="o">,</span> <span class="n">Iterable</span><span class="o">&lt;</span><span class="n">StockDailyDataWritable</span><span class="o">&gt;</span> <span class="n">values</span><span class="o">,</span> <span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">InterruptedException</span> <span class="o">{</span>
<span class="lineno">177</span>             <span class="n">StockMinMaxWritable</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="lineno">178</span>             <span class="k">for</span> <span class="o">(</span><span class="n">StockDailyDataWritable</span> <span class="nl">day:</span> <span class="n">values</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">179</span>                 <span class="k">if</span><span class="o">(</span><span class="kc">null</span> <span class="o">==</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">180</span>                     <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">StockMinMaxWritable</span><span class="o">();</span>
<span class="lineno">181</span>                     <span class="n">result</span><span class="o">.</span><span class="na">setMinDate</span><span class="o">(</span><span class="n">day</span><span class="o">.</span><span class="na">getDate</span><span class="o">());</span>
<span class="lineno">182</span>                     <span class="n">result</span><span class="o">.</span><span class="na">setMinPrice</span><span class="o">(</span><span class="n">day</span><span class="o">.</span><span class="na">getPriceLow</span><span class="o">());</span>
<span class="lineno">183</span>                     <span class="n">result</span><span class="o">.</span><span class="na">setMaxDate</span><span class="o">(</span><span class="n">day</span><span class="o">.</span><span class="na">getDate</span><span class="o">());</span>
<span class="lineno">184</span>                     <span class="n">result</span><span class="o">.</span><span class="na">setMaxPrice</span><span class="o">(</span><span class="n">day</span><span class="o">.</span><span class="na">getPriceHigh</span><span class="o">());</span>
<span class="lineno">185</span>                 <span class="o">}</span>
<span class="lineno">186</span>                 <span class="k">else</span> <span class="o">{</span>
<span class="lineno">187</span>                     <span class="k">if</span> <span class="o">(</span><span class="n">day</span><span class="o">.</span><span class="na">getPriceLow</span><span class="o">().</span><span class="na">compareTo</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">getMinPrice</span><span class="o">())</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
<span class="lineno">188</span>                             <span class="o">(</span><span class="n">day</span><span class="o">.</span><span class="na">getPriceLow</span><span class="o">().</span><span class="na">compareTo</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">getMinPrice</span><span class="o">())</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">day</span><span class="o">.</span><span class="na">getDate</span><span class="o">().</span><span class="na">compareTo</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">getMinDate</span><span class="o">())</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">))</span> <span class="o">{</span>
<span class="lineno">189</span>                         <span class="n">result</span><span class="o">.</span><span class="na">setMinPrice</span><span class="o">(</span><span class="n">day</span><span class="o">.</span><span class="na">getPriceLow</span><span class="o">());</span>
<span class="lineno">190</span>                         <span class="n">result</span><span class="o">.</span><span class="na">setMinDate</span><span class="o">(</span><span class="n">day</span><span class="o">.</span><span class="na">getDate</span><span class="o">());</span>
<span class="lineno">191</span>                     <span class="o">}</span>
<span class="lineno">192</span>                     <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">day</span><span class="o">.</span><span class="na">getPriceHigh</span><span class="o">().</span><span class="na">compareTo</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">getMaxPrice</span><span class="o">())</span> <span class="o">&gt;</span><span class="mi">0</span> <span class="o">||</span>
<span class="lineno">193</span>                             <span class="o">(</span><span class="n">day</span><span class="o">.</span><span class="na">getPriceHigh</span><span class="o">().</span><span class="na">compareTo</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">getMaxPrice</span><span class="o">())</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">day</span><span class="o">.</span><span class="na">getDate</span><span class="o">().</span><span class="na">compareTo</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">getMinDate</span><span class="o">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">))</span> <span class="o">{</span>
<span class="lineno">194</span>                         <span class="n">result</span><span class="o">.</span><span class="na">setMaxPrice</span><span class="o">(</span><span class="n">day</span><span class="o">.</span><span class="na">getPriceHigh</span><span class="o">());</span>
<span class="lineno">195</span>                         <span class="n">result</span><span class="o">.</span><span class="na">setMaxDate</span><span class="o">(</span><span class="n">day</span><span class="o">.</span><span class="na">getDate</span><span class="o">());</span>
<span class="lineno">196</span>                     <span class="o">}</span>
<span class="lineno">197</span>                 <span class="o">}</span>
<span class="lineno">198</span>             <span class="o">}</span>
<span class="lineno">199</span>             <span class="n">context</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
<span class="lineno">200</span>         <span class="o">}</span>
<span class="lineno">201</span>     <span class="o">}</span>
<span class="lineno">202</span> 
<span class="lineno">203</span>     <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
<span class="lineno">204</span>         <span class="n">Configuration</span> <span class="n">conf</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Configuration</span><span class="o">();</span>
<span class="lineno">205</span>         <span class="n">Job</span> <span class="n">job</span> <span class="o">=</span> <span class="n">Job</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">conf</span><span class="o">,</span> <span class="s">&quot;Min max calc&quot;</span><span class="o">);</span>
<span class="lineno">206</span>         <span class="n">job</span><span class="o">.</span><span class="na">setJarByClass</span><span class="o">(</span><span class="n">MinMaxCalc</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="lineno">207</span>         <span class="n">job</span><span class="o">.</span><span class="na">setMapperClass</span><span class="o">(</span><span class="n">StockMapper</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="lineno">208</span>         <span class="n">job</span><span class="o">.</span><span class="na">setReducerClass</span><span class="o">(</span><span class="n">StockReducer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="lineno">209</span>         <span class="n">job</span><span class="o">.</span><span class="na">setOutputKeyClass</span><span class="o">(</span><span class="n">Text</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="lineno">210</span>         <span class="n">job</span><span class="o">.</span><span class="na">setOutputValueClass</span><span class="o">(</span><span class="n">StockDailyDataWritable</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="lineno">211</span>         <span class="n">FileInputFormat</span><span class="o">.</span><span class="na">addInputPath</span><span class="o">(</span><span class="n">job</span><span class="o">,</span> <span class="k">new</span> <span class="nf">Path</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]));</span>
<span class="lineno">212</span>         <span class="n">FileOutputFormat</span><span class="o">.</span><span class="na">setOutputPath</span><span class="o">(</span><span class="n">job</span><span class="o">,</span> <span class="k">new</span> <span class="nf">Path</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">]));</span>
<span class="lineno">213</span>         <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="n">job</span><span class="o">.</span><span class="na">waitForCompletion</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="o">);</span>
<span class="lineno">214</span>     <span class="o">}</span>
<span class="lineno">215</span> 
<span class="lineno">216</span> <span class="o">}</span></code></pre></div>

<p>Unfortunatelly I found the result is wrong. All min price and max price are on the same day. </p>

<div class="highlight"><pre><code class="language-text" data-lang="text"><span class="lineno">1</span> AA  2001-03-05  37.38   2001-03-05  38.45
<span class="lineno">2</span> AAI 2000-05-08  4.44    2000-05-08  4.75
<span class="lineno">3</span> AAN 2000-04-10  14  2000-04-10  14.69
<span class="lineno">4</span> AAP 2001-12-12  42.11   2001-12-12  43.75
<span class="lineno">5</span> AAR 2001-05-11  24.52   2001-05-11  24.65
<span class="lineno">6</span> ...</code></pre></div>

<p>At first I thought there may be something wrong with the input: all the input values for one key have same value. But after I dumped all the values to output, all of them are as expected. Then I found something interesting, the comparisions on line 187 and 192 always return 0. In another word, the result object’s min and max price fields changed in every iteration. Who changed the value? </p>

<p>After some investigation, I found that Reducer’s context only created one instance of VALUEIN, and in every iteration, called its readFields methods to update the fields. So at the line 178, day’s readFields methods is called implicitly. Since line 181 to 184 have set results’ fields to day’s internal fields, so the fields changed by line 178 in every iteration and the min/max price and date would never be updated later.
<img src="/images/hadoop_reducer_valuein.jpg" alt="hadoop reducer values retrival" /></p>

<p>Then the fix is trival, just changing the set methold, using <code>this.minDate.set(minDate)</code> instead of <code>this.minDate = minDate</code>. And finally we got the expected results:</p>

<div class="highlight"><pre><code class="language-text" data-lang="text"><span class="lineno">1</span> AA  2000-10-20  23.12   2000-01-10  87.25
<span class="lineno">2</span> AAI 2001-09-20  2.6 2001-06-14  12.25
<span class="lineno">3</span> AAN 2000-06-29  11.47   2001-06-05  19.5
<span class="lineno">4</span> AAP 2001-12-04  39.7    2001-12-31  49.75
<span class="lineno">5</span> AAR 2001-09-21  17.6    2001-08-08  25.25
<span class="lineno">6</span> ...</code></pre></div>


  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">QAMichaelPeng</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>QAMichaelPeng</li>
          <li><a href="mailto:Not Available">Not Available</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/QAMichaelPeng">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">QAMichaelPeng</span>
            </a>
          </li>
          

          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">Thinking, coding.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
